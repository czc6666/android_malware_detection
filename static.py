# coding=utf-8
import os
from time import sleep

# root ä¸»è·¯å¾„å¯ä»¥æ”¾åœ¨æœºæ¢°ç¡¬ç›˜
root = '/home/czc/code/Android_Malware_Detection/'
# root1 é«˜é€Ÿç¼“å†²æ–‡ä»¶è·¯å¾„ï¼Œéœ€è¦æ”¾åœ¨å›ºæ€ç¡¬ç›˜
root1 = '/home/czc/code/Android_Malware_Detection/'

data_root_path = root + 'dataset/'  # æ•°æ®é›†å­˜æ”¾ä½ç½®
apktool_root_path = root + 'apk_tool/'  # apktoolå­˜æ”¾ä½ç½®
java_root_path = root + 'java/'  # javaå­˜æ”¾ä½ç½®
_3rd_root_path = root + '3rd/'  # ç¬¬ä¸‰æ–¹åº“å­˜æ”¾ä½ç½®
permission_feature_path = root + 'permission/'  # æƒé™ç‰¹å¾å­˜æ”¾ä½ç½®
token_path_root = root + 'tokenResult/'  # tokenç»“æœå­˜æ”¾ä½ç½®
cscg_root_path = root + 'class_set_call_graph/'  # ç±»é›†è°ƒç”¨å›¾å­˜æ”¾ä½ç½®
token_class_set_root_path = root + 'tokenClassSet/'  # tokenç±»é›†å­˜æ”¾ä½ç½®
java_src_tmp_path = root1 + 'java_src_tmp'  # javaæºç ä¸´æ—¶å­˜æ”¾ä½ç½®
model_path_prefix = root + 'model/'  # æ¨¡å‹å­˜æ”¾ä½ç½®
filelist_root = 'data/'  # æ–‡ä»¶åˆ—è¡¨å­˜æ”¾ä½ç½®
ts_max = 1500  
ts_min = 100  
total_process_multi_core = 8  # æ”¯æŒå¤šæ ¸å¿ƒè°ƒåº¦çš„å­è¿›ç¨‹çš„æ•°é‡ï¼Œå¦‚apktool, jadxç­‰
total_process_single_core = 50  # ä¸æ”¯æŒå¤šæ ¸å¿ƒè°ƒåº¦çš„å­è¿›ç¨‹æ•°é‡ï¼Œå¦‚CSCGæ„å»ºç­‰
MainDirMaxToken = 30000  # ä¸»ç›®å½•æœ€å¤§tokenæ•°
MaxToken = 100000  # æœ€å¤§tokenæ•°
MaxNodes = 1800  # æœ€å¤§èŠ‚ç‚¹æ•°
num_topics = 500  # ä¸»é¢˜æ•°
min_k_tmp_file = 'CSCG/min_k_tmp.txt'  # æœ€å°kå€¼ä¸´æ—¶æ–‡ä»¶

tfidf_dict_para = {
    'AMD_AndroZoo_demo':                 {'no_below': 1,   'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†æœ‰å¤§æ¦‚50ä¸ªapkï¼Œè¯é¢‘ä½äº1çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥   
    'AMD_AndroZoo':                      {'no_below': 50,  'no_above':  0.3},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰15000ä¸ªapkï¼Œè¯é¢‘ä½äº50çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.3çš„è¯å°†è¢«å¿½ç•¥
    'Drebin_AndroZoo':                   {'no_below': 40,  'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰12000ä¸ªapkï¼Œè¯é¢‘ä½äº40çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    'VirusShare_Apkpure':                {'no_below': 100, 'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰15000ä¸ªapkï¼Œè¯é¢‘ä½äº100çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    'b':                     {'no_below': 5,   'no_above':  0.4},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰1500ä¸ªapkï¼Œè¯é¢‘ä½äº5çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.4çš„è¯å°†è¢«å¿½ç•¥
    'czc_dataset_2':                     {'no_below': 2,   'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰140ä¸ªapkï¼Œè¯é¢‘ä½äº2çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    'VirusShare_Android_APK_2022-1':     {'no_below': 2,   'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰140ä¸ªapkï¼Œè¯é¢‘ä½äº2çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    'czc_dataset_4':                     {'no_below': 30,  'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰5000ä¸ªapkï¼Œè¯é¢‘ä½äº30çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    'czc_dataset_3':                     {'no_below': 7,   'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰2000ä¸ªapkï¼Œè¯é¢‘ä½äº7çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    'czc_dataset_5':                     {'no_below': 10,  'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰4500ä¸ªapkï¼Œè¯é¢‘ä½äº10çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    'czc_dataset_6':                     {'no_below': 10,  'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰1500ä¸ªapkï¼Œè¯é¢‘ä½äº10çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    'czc_dataset_7':                     {'no_below': 15,  'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰5000ä¸ªapkï¼Œè¯é¢‘ä½äº15çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    '2010-2012_Drebin+AndroZoo':         {'no_below': 40,  'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰12000ä¸ªapkï¼Œè¯é¢‘ä½äº40çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    '2013-2016-VirusShare+AndroZoo':     {'no_below': 40, 'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰21000ä¸ªapkï¼Œè¯é¢‘ä½äº40çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    '2017-2018-CICMalware2020+AndroZoo':     {'no_below': 40, 'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰21000ä¸ªapkï¼Œè¯é¢‘ä½äº40çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
    '2019-2023-VirusShare+AndroZoo': {'no_below': 40, 'no_above':  0.5},  # è¿™ä¸ªæ•°æ®é›†å¤§æ¦‚æœ‰21000ä¸ªapkï¼Œè¯é¢‘ä½äº40çš„è¯å°†è¢«å¿½ç•¥ï¼Œè¯é¢‘é«˜äº0.5çš„è¯å°†è¢«å¿½ç•¥
}  # è¯å…¸å‚æ•°ï¼Œno_belowè¡¨ç¤ºè¯é¢‘ä½äºè¯¥å€¼çš„è¯å°†è¢«å¿½ç•¥ï¼Œno_aboveè¡¨ç¤ºè¯é¢‘é«˜äºè¯¥å€¼çš„è¯å°†è¢«å¿½ç•¥


def get_dataset_name():  # é€‰æ‹©æ•°æ®é›†
    select = int(input(
        "ğŸ”é€‰æ‹©æ•°æ®é›†ï¼š\n\
        1. 2010-2012_Drebin+AndroZoo\n\
        2. 2013-2016-VirusShare+AndroZoo\n\
        3. 2017-2018-CICMalware2020+AndroZoo\n\
        4. 2019-2023-VirusShare+AndroZoo\n\
        5. czc_dataset_7ï¼ˆå°æ•°æ®é›†ï¼Œè°ƒè¯•ç”¨ï¼‰\n"))
    if select == 1:
        dataset_name = '2010-2012_Drebin+AndroZoo'
    elif select == 2:
        dataset_name = '2013-2016-VirusShare+AndroZoo'
    elif select == 3:
        dataset_name = '2017-2018-CICMalware2020+AndroZoo'
    elif select == 4:
        dataset_name = '2019-2023-VirusShare+AndroZoo'
    elif select == 5:
        dataset_name = 'czc_dataset_7'
    else:
        print("è¾“å…¥é”™è¯¯")
        raise Exception
    return dataset_name

def get_project_root():  # è·å–é¡¹ç›®æ ¹ç›®å½•
    return root

def get_apk_path(dataset):  # è·å–apkè·¯å¾„
    dataset_path_prefix = dataset + '/'  # æ•°æ®é›†è·¯å¾„å‰ç¼€
    apk_path = data_root_path + dataset_path_prefix  # apkå­˜æ”¾ä½ç½®
    manifest_path = apktool_root_path + dataset_path_prefix + 'manifest/'  # manifestå­˜æ”¾ä½ç½®
    dex_path = apktool_root_path + dataset_path_prefix + 'dex/'  # dexå­˜æ”¾ä½ç½®
    java_path = java_root_path + dataset_path_prefix  # javaå­˜æ”¾ä½ç½®
    _3rd_path = _3rd_root_path + dataset_path_prefix  # ç¬¬ä¸‰æ–¹åº“å­˜æ”¾ä½ç½®
    permission_path = permission_feature_path + dataset_path_prefix  # æƒé™ç‰¹å¾å­˜æ”¾ä½ç½®
    token_path = token_path_root + dataset_path_prefix  # tokenç»“æœå­˜æ”¾ä½ç½®
    filelist_train = filelist_root + dataset + '_train.filelist'  # è®­ç»ƒé›†æ–‡ä»¶åˆ—è¡¨
    filelist_test = filelist_root + dataset + '_test.filelist'  # æµ‹è¯•é›†æ–‡ä»¶åˆ—è¡¨
    filelist_train_filter = filelist_root + dataset + '_train.filter'  # è®­ç»ƒé›†è¿‡æ»¤åæ–‡ä»¶åˆ—è¡¨
    filelist_test_filter = filelist_root + dataset + '_test.filter'  # æµ‹è¯•é›†è¿‡æ»¤åæ–‡ä»¶åˆ—è¡¨

    for path in [apk_path, manifest_path, dex_path, java_path, _3rd_path, permission_path, token_path]:  
        # æ£€æŸ¥è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
        if not os.path.exists(path):  # æ£€æŸ¥è·¯å¾„æ˜¯å¦å­˜åœ¨
            os.system("mkdir -p " + path)  # åˆ›å»ºè·¯å¾„
    return apk_path, manifest_path, dex_path, java_path, _3rd_path, \
        permission_path, token_path, filelist_train, filelist_test, \
        filelist_train_filter, filelist_test_filter


# 2. 'cscg'è¡¨ç¤ºå¯¹class-setæå–lsiçš„é…ç½®
def get_lsi_config(dataset, type='lsi'):
    dataset_path_prefix = dataset + '/'
    train_file = filelist_root + dataset + '_train.filter'
    test_file = filelist_root + dataset + '_test.filter'
    if type == 'lsi':
        token_root = token_path_root + dataset_path_prefix
        model_root = model_path_prefix + dataset_path_prefix  # ['model_root']
    elif type == 'cscg':
        token_root = token_class_set_root_path + dataset_path_prefix
        model_root = model_path_prefix + dataset_path_prefix  # ['model_root']
    else:
        print('Only support "lsi" and "csbd", not include ' + type + '!')
        raise Exception
    if not os.path.exists(model_root):
        os.system('mkdir -p ' + model_root)
    TFIDF_dict_path = model_root + 'black_white_asm.dict'  # ['TFIDF_dict']
    dict_corpus = model_root + 'black_white_corpus.dict'  # ['dict_corpus']
    TFIDF_model = model_root + 'tfidf.model'  # ['TFIDF_model']
    TFIDF_corpus_path = model_root + 'black_white_corpus_tfidf.mm'  # ['TFIDF_corpus']
    LSI_model_path = model_root + 'lsi.model'  # ['LSI_model_path']
    no_below = tfidf_dict_para[dataset]['no_below']
    no_above = tfidf_dict_para[dataset]['no_above']

    if type == 'lsi':
        LSI_corpus_path = model_root + 'lsi_result.txt'  # ['LSI_corpus']
        LSI_corpus_path_test = model_root + 'lsi_result_test.txt'  # ['LSI_corpus_test']
    else:
        LSI_corpus_path = model_root + 'lsi_result/'  # ['LSI_corpus']
        LSI_corpus_path_test = model_root + 'lsi_result_test/'  # ['LSI_corpus_test']
        if not os.path.exists(LSI_corpus_path):
            os.mkdir(LSI_corpus_path)
        if not os.path.exists(LSI_corpus_path_test):
            os.mkdir(LSI_corpus_path_test)
    apktool_root = apktool_root_path + dataset_path_prefix

    return train_file, test_file, TFIDF_dict_path, dict_corpus, TFIDF_model, TFIDF_corpus_path, LSI_model_path, LSI_corpus_path, LSI_corpus_path_test, token_root, apktool_root, no_below, no_above

def get_xgboost_config(dataset_name):
    model_root = model_path_prefix + dataset_name + '/'
    LSI_Permission_file = model_root + 'lsi_permission.txt'  # ['LSI_Permission_file']
    LSI_per_xgboost_model = model_root + 'lsi_permission_xgboost.model'  # ['lsi_per_xgboost_model']
    LSI_corpus_path = model_root + 'lsi_result.txt'  # ['LSI_corpus']
    LSI_corpus_path_test = model_root + 'lsi_result_test.txt'  # ['LSI_corpus_test']
    LSI_Permission_file_test = model_root + 'lsi_permission_test.txt'  # ['LSI_Permission_file_test']
    permission_path = permission_feature_path + dataset_name +'/'
    return LSI_Permission_file, LSI_Permission_file_test, LSI_per_xgboost_model, LSI_corpus_path, LSI_corpus_path_test, permission_path


def get_cscg_config(dataset):
    dataset_path_prefix = dataset + '/'
    java_path = java_root_path + dataset_path_prefix
    java_graph_path = cscg_root_path + dataset_path_prefix
    _3rd_path = _3rd_root_path + dataset_path_prefix
    token_java_path = token_class_set_root_path + dataset_path_prefix

    for path in [java_path, java_graph_path, _3rd_path, token_java_path]:
        if not os.path.exists(path):
            os.system("mkdir -p " + path)

    return java_path, java_graph_path, _3rd_path, token_java_path


def get_graph_config(dataset):
    train_file = filelist_root + dataset + '_train.filter'
    test_file = filelist_root + dataset + '_test.filter'
    model_root = model_path_prefix + dataset + '/'  # ['model_root']
    graph_path = cscg_root_path + dataset + '/'

    if not os.path.exists(model_root):
        os.system('mkdir -p ' + model_root)
    LSI_corpus_path = model_root + 'lsi_result/'  # ['LSI_corpus']
    LSI_corpus_path_test = model_root + 'lsi_result_test/'  # ['LSI_corpus_test']
    if not os.path.exists(LSI_corpus_path):
        os.mkdir(LSI_corpus_path)
    if not os.path.exists(LSI_corpus_path_test):
        os.mkdir(LSI_corpus_path_test)
    train_lsi_fearue_file = model_root + 'lsi_result.txt'
    test_lsi_fearue_file = model_root + 'lsi_result_test.txt'
    permission_root = permission_feature_path + dataset + '/'
    return train_file, test_file, LSI_corpus_path, LSI_corpus_path_test, graph_path, model_root, permission_root, train_lsi_fearue_file, test_lsi_fearue_file
