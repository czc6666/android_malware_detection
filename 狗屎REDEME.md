全都是狗屎


```bash

conda create -n py27 python=2.7 \
&& conda create -n py38 python=3.8 \
&& pip install scikit-learn xgboost gensim javalang matplotlib psutil -i https://pypi.tuna.tsinghua.edu.cn/simple/ \

# 激活python2.7环境
sudo apt install openjdk-11-jdk \
&& conda activate py27 \
&& python 1.main_literadar_python27.py \
&& conda activate py38 \
&& python 2.main_preprocess_python3.py \
&& rm -rf /home/wzd/czc/code/Android_Malware_Detection/3rd/* \
&& rm -rf /home/wzd/czc/code/Android_Malware_Detection/apk_tool* \
&& rm -rf /home/wzd/czc/code/Android_Malware_Detection/class_set_call_graph/* \
&& rm -rf /home/wzd/czc/code/Android_Malware_Detection/java/* \
&& rm -rf /home/wzd/czc/code/Android_Malware_Detection/permission/* \
&& rm -rf /home/wzd/czc/code/Android_Malware_Detection/tokenClassSet/* \
&& rm -rf /home/wzd/czc/code/Android_Malware_Detection/tokeResult/* \
&& conda activate py27 \
&& python 1.main_literadar_python27.py \
&& conda activate py38 \
&& python 2.main_preprocess_python3.py \
&& python 3.main_lsi_train_python3.py \
&& python 4.main_cscg_construct_python3.py
```

### 2.1 修改配置文件 (Modify the configuration file)

&ensp;&ensp;&ensp;&ensp;代码基于Ubuntu 22.04，cuda 11.8环境下运行。

&ensp;&ensp;&ensp;&ensp;配置文件主要是static.py，内部root和root1需要提前配置。其中root用于存放运行阶段所有中间文件，考虑较大空间的机械硬盘;
root1用于临时存放jadx反编译得到的java文件，之后将java文件打包成zip文件，以减少IO占用。因此root1建议使用固态硬盘。

&ensp;&ensp;&ensp;&ensp;此外，如新增数据集，则需要在static.py的tfidf_dict_para常量里增加数据集对应TFIDF的no_below和no_above。同时定义当前跑的数据集名

&ensp;&ensp;&ensp;&ensp;原始apk文件存放在"../../dataset/"下的文件夹，对应样本训练集与测试集拆分以及样本标签存在的"data/"下对应的".filelist"文件里，其中b为malware，w为benign。

&ensp;&ensp;&ensp;&ensp;1-5，这5个python文件中的main方法包含数据集名，都在static.py中定义，在运行前需要对应修改。


### 2.1. 运行LibRadar (Run LibRadar)
&ensp;&ensp;&ensp;&ensp;由于LibRadar基于Python 2.7实现，较难迁移至Python 3下，选择单独运行 。本代码中会初步对不完整apk、错误编码的dex文件进行过滤删除并记录错误apk列表

    python2 1.main_literadar_python27.py

&ensp;&ensp;&ensp;&ensp;该部分会生成体积很大的log_libradar.txt, 并在"LiteRadar/Data/Decompiled/"下保留反编译（解压出的dex）的文件，需要及时清理

### 2.2. 运行预处理过程 (Preprocessing)
&ensp;&ensp;&ensp;&ensp;该部分包含apktool逆向、jadx反编译、完整APK的token提取、权限特征提取。

&ensp;&ensp;&ensp;&ensp;首先对第一步记录清除错误apk数据集后的标签进行初步过滤。之后为了确保我们的程序可以处理全部数据，我们对filelist的样本进行了筛选，去掉三方库、Java源代码等不完整的样本，并将筛选后的样本列表保存在"data/"下的".filter"文件内。

    python3 2.main_preprocess_python3.py

### 2.3. 训练LSI模型，并计算完整APK的LSI向量 (LSI model training and LSI vector of whole APK file calculation)
&ensp;&ensp;&ensp;&ensp;该部分实现我们之前的方法，作为本论文方法的基础。

&ensp;&ensp;&ensp;&ensp;该部分首先基于训练集训练LSI模型，并计算训练集和测试集的LSI特征，并与权限特征拼接后训练XGBoost模型，并输出测试结果。

    python3 3.main_lsi_train_python3.py

---

### 2.4. CSCG构建 (Construction of CSCG)
&ensp;&ensp;&ensp;&ensp;该部分首先计算数据集的min_k；接下来构建全部的CSCG，包括节点合并、调用关系计算、以及节点的LSI特征计算；最后，为了保证多次调参减少IO的占用，
选择将整个数据集合并为大文件，防止每次训练读取大量碎文件。
czc：cscg构建伴随着dex的进一步提取，提取过程中过滤删除个别错误编码dex对于apk数据集，并清理标签数据集

    python3 4.main_cscg_construct_python3.py

### 2.5. 模型训练与测试 (Model training and testing)
&ensp;&ensp;&ensp;&ensp;该部分对CSCG进行特征提取，并进行分类。对该模型的调参，则在"GAT/graph_net.py"中修改，通常主要修改 "self.args["lr"]" 和 "self.args["num_heads_per_layer"]" 两个参数，lr尝试0.001和0.002，num_heads_per_layer尝试2-8。

    python3 5.main_graph_test_python3.py
