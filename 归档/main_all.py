# coding=utf-8

"""
20241028
czc_dataset_3ï¼š1400ä¸ªapk
Test set (epoch 50): Average loss: 0.3428, Accuracy: 268/280 (95.71%)   sec/iter: 0.0235
0->0: 186, 0->1: 0, 1->0: 12, 1->1: 82
[[95.71428571428571, 186, 0, 12, 82]]
Test avg acc (+- std): 95.71428571428571 (0.0)
æ€»è¿è¡Œæ—¶é—´: 2894.1372158527374 ç§’
æ€»è¿è¡Œæ—¶é—´: 644.34 ç§’
"""
import os
from multiprocessing import Pool
from Decompilation.apktool import apktool
from Decompilation.jar2java import jar2java
from LiteRadar.filter_dex import filter_dex
from static import get_apk_path, get_lsi_config, get_xgboost_config, get_cscg_config, get_graph_config
from static import total_process_multi_core, total_process_single_core, java_src_tmp_path, ts_max, min_k_tmp_file
from static import get_dataset_name
from lexical_analysis.extract_token import extract_token
from Permission.permissionExtract import extractPermission
from dataset_construct.create_filelist import create_filelist
from lsi.lsi import lsi_train, lsi_test
from xgb_classification.combine_lsi_permission import combine_lsi_permission
from xgb_classification.xgboost_clf import train_xgb_model, test_xgb_model
from CSCG.calculate_min_k import calculate_min_k
from CSCG.java_graph import get_cscg_dataset
from GAT.create_graph_dataset import create_graph_files
from GAT.graph_net import graph_model
import time


program_root = os.getcwd()
# æ·»åŠ apktoolçš„ç¯å¢ƒå˜é‡
os.environ["PATH"] = program_root + '/tools/apktool/' + ":" + os.environ["PATH"]
# æ·»åŠ jadxçš„ç¯å¢ƒå˜é‡
os.environ["PATH"] = program_root + '/tools/jadx/build/jadx/bin/' + ":" + os.environ["PATH"]

# å¯¹åŸå§‹APKæ–‡ä»¶è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬åç¼–è¯‘ã€ä¸‰æ–¹åº“è¿‡æ»¤ç­‰,åœ¨python2.7ä¸‹è¿è¡Œ
def literadar(dataset):
    # 1. è·å–æ•°æ®é›†çš„é…ç½®
    apk_path, manifest_path, dex_path, java_path, _3rd_path, permission_path, token_path, filelist_train, filelist_test, filelist_train_filter, filelist_test_filter = get_apk_path(dataset)

    # 2.ä½¿ç”¨LiteRadarè·å–æ¯ä¸ªapkæ–‡ä»¶çš„ä¸‰æ–¹åº“,åœ¨python2.7ä¸‹è¿è¡Œ
    filter_dex(apk_path, _3rd_path, total_process_multi_core)

# å¯¹åŸå§‹APKæ–‡ä»¶è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬åç¼–è¯‘ã€ä¸‰æ–¹åº“è¿‡æ»¤ç­‰,åœ¨python3.6ä¸‹è¿è¡Œ
def preproces(dataset):
    apk_path, manifest_path, dex_path, java_path, _3rd_path, permission_path, token_path, filelist_train, filelist_test, filelist_train_filter, filelist_test_filter = get_apk_path(dataset)

    # 2.ä½¿ç”¨apktoolè·å–æ¯ä¸ªæ–‡ä»¶çš„Androidmanifest.xmlå’Œclass.dex,åœ¨python2.7ä¸‹è¿è¡Œ
    apktool(apk_path, manifest_path, dex_path, total_process_multi_core)
    # 3.ä½¿ç”¨jadxå¯¹æ¯ä¸ªclass.dexè¿›è¡Œåç¼–è¯‘ï¼Œå¹¶å°†åç¼–è¯‘çš„å…¨éƒ¨javaæ–‡ä»¶æ‰“åŒ…ç”Ÿæˆ.zipçš„å‹ç¼©åŒ…,åœ¨python3.6ä¸‹è¿è¡Œ
    jar2java(dex_path, java_path, java_src_tmp_path, program_root, total_process_multi_core)

    # 4.å¯¹æ¯ä¸ªåç¼–è¯‘å¾—åˆ°çš„javaæ–‡ä»¶è¿›è¡Œtokenæå–,åœ¨python3.6ä¸‹è¿è¡Œ
    extract_token(dataset, _3rd_path, java_path, manifest_path, token_path, total_process_single_core)

    # 5.å¯¹æ¯ä¸ªmanifestæ–‡ä»¶æå–æƒé™ç‰¹å¾,åœ¨python3.6ä¸‹è¿è¡Œ
    extractPermission(manifest_path, permission_path)

    # 6.ç”Ÿæˆè®°å½•æ¯ä¸ªæ•°æ®é›†ä¸‹å…¨éƒ¨æœ‰æ•ˆæ•°æ®çš„æ–‡ä»¶filelist.txt,åœ¨python3.6ä¸‹è¿è¡Œ
    create_filelist(filelist_train, filelist_train_filter, _3rd_path, manifest_path, java_path)

    # 7.ç”Ÿæˆè®°å½•æ¯ä¸ªæ•°æ®é›†ä¸‹å…¨éƒ¨æœ‰æ•ˆæ•°æ®çš„æ–‡ä»¶filelist.txt,åœ¨python3.6ä¸‹è¿è¡Œ
    create_filelist(filelist_test, filelist_test_filter, _3rd_path, manifest_path, java_path)


# åœ¨python3.6ä¸‹è¿è¡Œ
# ä»…ä½¿ç”¨è¯­ä¹‰æ¨¡å‹å’Œpermissionç‰¹å¾è¿›è¡Œæ¨¡å‹è®­ç»ƒ
def lsi_model_train(dataset):
    # 8.è·å–lsiæ¨¡å‹è®­ç»ƒæ‰€éœ€å…¨éƒ¨æ–‡ä»¶çš„è·¯å¾„
    train_file, test_file, TFIDF_dict_path, dict_corpus, TFIDF_model_path, TFIDF_corpus_path, LSI_model_path, LSI_corpus_path, LSI_corpus_path_test, token_root, apktool_root_path, no_below, no_above = get_lsi_config(dataset)

    # 9.è¿›è¡ŒLSIæ¨¡å‹çš„è®­ç»ƒï¼Œå†…éƒ¨åŒ…å«TFIDFæ¨¡å‹çš„è®­ç»ƒï¼Œå¹¶ç”Ÿæˆè®­ç»ƒç‰¹å¾æ–‡ä»¶
    lsi_train(dataset, train_file, TFIDF_dict_path, dict_corpus, TFIDF_model_path, TFIDF_corpus_path, LSI_model_path, LSI_corpus_path, token_root, no_below=no_below, no_above=no_above)

    # 10.ç”Ÿæˆæµ‹è¯•é›†çš„ç‰¹å¾å‘é‡
    lsi_test(dataset, test_file, TFIDF_dict_path, TFIDF_model_path, LSI_model_path, LSI_corpus_path_test, token_root)

    # 11.è·å–æ•°æ®é›†ä¸æ¨¡å‹çš„ç›¸å…³ä¿¡æ¯
    LSI_Permission_file, LSI_Permission_file_test, lsi_per_xgboost_model, LSI_corpus_path, LSI_corpus_path_test, permission_dir_path = get_xgboost_config(dataset)

    # 12.ç”Ÿæˆlsiå’Œpermissionæ‹¼æ¥åè®­ç»ƒé›†çš„ç‰¹å¾
    combine_lsi_permission(dataset, LSI_corpus_path, permission_dir_path, LSI_Permission_file)

    # 13.ç”Ÿæˆæµ‹è¯•é›†çš„lsiä¸permissionæ‹¼æ¥ç‰¹å¾
    combine_lsi_permission(dataset, LSI_corpus_path_test, permission_dir_path, LSI_Permission_file_test)

    # 14.è®­ç»ƒXGBoostæ¨¡å‹è¿›è¡Œåˆ†ç±»
    train_xgb_model(LSI_Permission_file, lsi_per_xgboost_model)

    # 15.æµ‹è¯•XGBoostæ¨¡å‹çš„æ•ˆæœ
    test_xgb_model(LSI_Permission_file_test, lsi_per_xgboost_model)


# åŸºäºjavaæ–‡ä»¶çš„importå…³ç³»è¿›è¡Œå›¾æ„å»ºï¼Œç›¸å½“äºpublic classçš„è°ƒç”¨å…³ç³»ï¼Œå¹¶ä¿ç•™ä¸€å®šçš„3rdåº“ï¼Œä½¿å¾—è¿‡æ»¤åèŠ‚ç‚¹æ•°é‡å°äº100çš„ï¼Œå°½é‡è¡¥å……åˆ°æ¥è¿‘100
def class_set_call_graph(dataset):
    # dataset_name æ•°æ®é›†çš„åç§°,
    # java_path åŸå§‹javaä»£ç å‹ç¼©åŒ…çš„å­˜æ”¾è·¯å¾„,
    # java_graph_path ä¿å­˜class-set call graphè°ƒç”¨å…³ç³»çš„è·¯å¾„,
    # _3rd_path ä¸‰æ–¹åº“æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„,
    # token_file_root ä¿å­˜æ¯ä¸ªclass-setçš„æ­¤æ³•åˆ†æå¾—åˆ°çš„tokens,
    # min_k è¯¥æ•°æ®é›†ä¸‹çš„min_kå€¼
    # 16.è·å–CSCGçš„é…ç½®ä¿¡æ¯
    java_path, java_graph_path, _3rd_path, token_file_root= get_cscg_config(dataset)
    train_file, test_file, TFIDF_dict_path, dict_corpus, TFIDF_model_path, TFIDF_corpus_path, LSI_model_path, LSI_corpus_path, LSI_corpus_path_test, token_root, apktool_root_path, no_below, no_above = get_lsi_config(dataset, type='cscg')

    # 17.è®¡ç®—min_k
    min_k = calculate_min_k(dataset, java_path, train_file, ts_max, min_k_tmp_file)

    # 18.è®¡ç®—CSCGè°ƒç”¨å›¾ï¼Œå¹¶å¯¹èŠ‚ç‚¹è¿›è¡Œåˆ†è¯
    get_cscg_dataset(dataset, java_path, java_graph_path, _3rd_path, token_file_root, min_k=min_k, total_process=total_process_single_core)

    # æå–class-setçš„LSIå‘é‡ï¼Œæ¯ä¸ªAPKä¿å­˜æˆä¸€ä¸ªæ–‡ä»¶
    pool = Pool(processes=2)
    # 19.ç”Ÿæˆè®­ç»ƒé›†çš„èŠ‚ç‚¹ç‰¹å¾å‘é‡
    # lsi_test(dataset, train_file, TFIDF_dict_path, TFIDF_model_path, LSI_model_path, LSI_corpus_path, token_root, type='cscg')
    pool.apply_async(lsi_test, (dataset, train_file, TFIDF_dict_path, TFIDF_model_path, LSI_model_path, LSI_corpus_path, token_root, 'cscg'))

    # 20.ç”Ÿæˆæµ‹è¯•é›†çš„èŠ‚ç‚¹ç‰¹å¾å‘é‡
    # lsi_test(dataset, test_file, TFIDF_dict_path, TFIDF_model_path, LSI_model_path, LSI_corpus_path_test, token_root, type='cscg')
    pool.apply_async(lsi_test, (dataset, test_file, TFIDF_dict_path, TFIDF_model_path, LSI_model_path, LSI_corpus_path_test, token_root, 'cscg'))
    pool.close()
    pool.join()

    # raise Exception
    # é˜²æ­¢å¤šæ¬¡è°ƒå‚æ—¶ï¼Œè¯»å–ç¢æ–‡ä»¶å¤ªè€—æ—¶é—´ï¼Œå› æ­¤å…ˆå°†CSCGä¿å­˜æˆå¤§æ–‡ä»¶
    pool = Pool(processes=2)

    # 21.è¯»å–PSCNçš„è¾“å…¥graphæºæ–‡ä»¶
    train_file, test_file, LSI_corpus_path, LSI_corpus_path_test, graph_file_root, model_root, permission_feature_path, lsi_fearue_file, lsi_fearue_file_test = get_graph_config(
        dataset)

    # 22.ç”Ÿæˆè®­ç»ƒé›†çš„graphæ–‡ä»¶
    # create_graph_files(train_file, graph_file_root, LSI_corpus_path, model_root, lsi_fearue_file, permission_feature_path=permission_feature_path, type='cscg', apktool_root_path=apktool_root_path, add_root=False)
    pool.apply_async(create_graph_files, (train_file, graph_file_root, LSI_corpus_path, model_root, lsi_fearue_file, permission_feature_path, 'cscg', apktool_root_path, False))

    # 23.ç”Ÿæˆæµ‹è¯•é›†çš„graphæ–‡ä»¶
    # create_graph_files(test_file, graph_file_root, LSI_corpus_path_test, model_root, lsi_fearue_file_test, permission_feature_path=permission_feature_path, type='cscg',  apktool_root_path=apktool_root_path)
    pool.apply_async(create_graph_files, (test_file, graph_file_root, LSI_corpus_path_test, model_root, lsi_fearue_file_test, permission_feature_path, 'cscg', apktool_root_path, False))
    pool.close()
    pool.join()

# åŸºäºjavaæ–‡çš„importå…³ç³»è¿›è¡Œå›¾æ„å»ºï¼Œç›¸å½“äºpublic classçš„è°ƒç”¨å…³ç³»ï¼Œå¹¶ä¿ç•™ä¸€å®šçš„3rdåº“ï¼Œä½¿å¾—è¿‡æ»¤åèŠ‚ç‚¹æ•°é‡å°äº100çš„ï¼Œå°½é‡è¡¥å……åˆ°æ¥è¿‘100
def class_set_call_graph_test():
    # 12.è¯»å–PSCNçš„è¾“å…¥graphæºæ–‡ä»¶
    train_file, test_file, LSI_corpus_path, LSI_corpus_path_test, graph_file_root, model_root, permission_feature_path, lsi_fearue_file, lsi_fearue_file_test = get_graph_config(dataset)

    # 15.graph_netè®­ç»ƒæµ‹è¯•
    graph_model(model_root, dataset)

if __name__ == '__main__':

    # è®¡ç®—å½“å‰æ—¶é—´
    start_time = time.time()
    dataset = get_dataset_name()

    # literadar(dataset)
    preproces(dataset)
    lsi_model_train(dataset)
    class_set_call_graph(dataset)
    class_set_call_graph_test()
    
    # è®¡ç®—æ€»è¿è¡Œæ—¶é—´
    end_time = time.time()
    print(f'ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜æ€»è¿è¡Œæ—¶é—´: {end_time - start_time} ç§’')
