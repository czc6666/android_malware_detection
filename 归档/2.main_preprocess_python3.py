# coding=utf-8

"""
è¿™é‡Œç¬¬ä¸€æ­¥å…ˆå¯¹æ ‡ç­¾æ•°æ®è¿›è¡Œæ¸…æ´—ï¼Œç”¨è‡ªå·±å†™çš„æ–¹æ³•ï¼ˆ1.mainå·²ç»åˆ é™¤äº†é”™è¯¯apkï¼‰

æ•°æ®é›†ï¼šczc_dataset_VS_Drebin_AndroZoo 6000ä¸ªapkï¼Œè¿è¡Œæ—¶é—´: 11809.45 ç§’

æ•°æ®é›†ï¼šczc_dataset_4ä¸ª6000ä¸ªapkï¼Œæ€»è¿è¡Œæ—¶é—´: 9978.65 ç§’
æ•°æ®é›†ï¼šczc_dataset_5ä¸ª5000ä¸ªapkï¼Œæ€»è¿è¡Œæ—¶é—´: 28959.77 ç§’
"""

import os
from Decompilation.apktool import apktool
from Decompilation.jar2java import jar2java
from static import get_apk_path, get_lsi_config, get_xgboost_config, get_cscg_config, get_graph_config
from static import total_process_multi_core, total_process_single_core, java_src_tmp_path, ts_max, min_k_tmp_file
from static import get_dataset_name
from lexical_analysis.extract_token import extract_token
from Permission.permissionExtract import extractPermission
from dataset_construct.create_filelist import create_filelist
import time
from czc.dataset_clean.clean_label_from_apkset import clean_label


program_root = os.getcwd()
# æ·»åŠ apktoolçš„ç¯å¢ƒå˜é‡
os.environ["PATH"] = program_root + '/tools/apktool/' + ":" + os.environ["PATH"]
# æ·»åŠ jadxçš„ç¯å¢ƒå˜é‡
os.environ["PATH"] = program_root + '/tools/jadx/build/jadx/bin/' + ":" + os.environ["PATH"]


# å¯¹åŸå§‹APKæ–‡ä»¶è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬åç¼–è¯‘ç­‰,åœ¨python3.6ä¸‹è¿è¡Œ
def preproces(dataset):

    print('ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”å¼€å§‹æ¸…ç†æ ‡ç­¾æ–‡ä»¶')
    time.sleep(2)
    clean_label(dataset)
    print('ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”æ¸…ç†æ ‡ç­¾æ–‡ä»¶å®Œæˆ')

    apk_path, manifest_path, dex_path, java_path, _3rd_path, permission_path, token_path, filelist_train, filelist_test, filelist_train_filter, filelist_test_filter = get_apk_path(dataset)

    # 2.ä½¿ç”¨apktoolè·å–æ¯ä¸ªæ–‡ä»¶çš„Androidmanifest.xmlå’Œclass.dex,åœ¨python2.7ä¸‹è¿è¡Œ
    # æå–xmlå’Œdex
    apktool(apk_path, manifest_path, dex_path, total_process_multi_core)

    # 3.ä½¿ç”¨jadxå¯¹æ¯ä¸ªclass.dexè¿›è¡Œåç¼–è¯‘ï¼Œå¹¶å°†åç¼–è¯‘çš„å…¨éƒ¨javaæ–‡ä»¶æ‰“åŒ…ç”Ÿæˆ.zipçš„å‹ç¼©åŒ…,åœ¨python3.6ä¸‹è¿è¡Œ
    # åç¼–è¯‘dexå‡ºjavaä»£ç æ‰“åŒ…æˆzip
    jar2java(dex_path, java_path, java_src_tmp_path, program_root, total_process_multi_core)

    '''
    åœ¨DirAndFile.extractTokenæ–¹æ³•ä¸­ï¼Œå¯¹äºæ¯ä¸ªJavaæ–‡ä»¶ï¼Œå®ƒé¦–å…ˆä½¿ç”¨FileUtil.readFileè¯»å–æ–‡ä»¶å†…å®¹ï¼Œ
    ç„¶ååˆ›å»ºä¸€ä¸ªTestLexerå®ä¾‹ï¼Œå¹¶è°ƒç”¨analyseæ–¹æ³•æ¥æå–tokensã€‚
    æå–çš„tokensè¢«å­˜å‚¨åœ¨DirAndFile.tokenResultåˆ—è¡¨ä¸­ï¼Œæœ€åè¿™äº›tokenså¯ä»¥è¢«å†™å…¥åˆ°ä¸€ä¸ªç»“æœæ–‡ä»¶ä¸­ã€‚
    '''
    # 4.å¯¹æ¯ä¸ªåç¼–è¯‘å¾—åˆ°çš„javaæ–‡ä»¶è¿›è¡Œtokenæå–,åœ¨python3.6ä¸‹è¿è¡Œ
    # æå–tokenï¼Œtokenä¹Ÿå«è¯æ³•å•å…ƒï¼Œé€šå¸¸åŒ…æ‹¬å…³é”®å­—ã€æ ‡è¯†ç¬¦ã€å¸¸æ•°ã€è¿ç®—ç¬¦ç­‰ã€‚
    extract_token(dataset, _3rd_path, java_path, manifest_path, token_path, total_process_single_core)

    # 5.å¯¹æ¯ä¸ªmanifestæ–‡ä»¶æå–æƒé™ç‰¹å¾,åœ¨python3.6ä¸‹è¿è¡Œ
    # æå–xmlçš„æƒé™ç‰¹å¾ï¼Œ59ç»´æƒé™ç‰¹å¾
    extractPermission(manifest_path, permission_path)

    # 6.ç”Ÿæˆè®°å½•æ¯ä¸ªæ•°æ®é›†ä¸‹å…¨éƒ¨æœ‰æ•ˆæ•°æ®çš„æ–‡ä»¶filelist.txt,åœ¨python3.6ä¸‹è¿è¡Œï¼ˆç‹—å±ä¸é€šï¼‰
    # ğŸ˜¥åˆ›å»ºè¿‡æ»¤ï¼ˆç¬¬ä¸‰æ–¹åº“ï¼‰åçš„æ–‡ä»¶åˆ—è¡¨ã€‚ã€‚6.ä¸ºè®­ç»ƒæ•°æ®é›†ç”ŸæˆåŒ…å«æ‰€æœ‰æœ‰æ•ˆæ•°æ®æ–‡ä»¶è·¯å¾„çš„filelist.txtæ–‡ä»¶ï¼ˆczcçš„æ³¨é‡Šï¼‰
    create_filelist(filelist_train, filelist_train_filter, _3rd_path, manifest_path, java_path)

    # 7.ç”Ÿæˆè®°å½•æ¯ä¸ªæ•°æ®é›†ä¸‹å…¨éƒ¨æœ‰æ•ˆæ•°æ®çš„æ–‡ä»¶filelist.txt,åœ¨python3.6ä¸‹è¿è¡Œï¼ˆç‹—å±ä¸é€šï¼‰
    # 7.ä¸ºæµ‹è¯•æ•°æ®é›†ç”ŸæˆåŒ…å«æ‰€æœ‰æœ‰æ•ˆæ•°æ®æ–‡ä»¶è·¯å¾„çš„filelist.txtæ–‡ä»¶ï¼ˆczcçš„æ³¨é‡Šï¼‰
    create_filelist(filelist_test, filelist_test_filter, _3rd_path, manifest_path, java_path)


def main():
    # æ”¶é›†å¼€å§‹æ—¶é—´
    start_time = time.time()

    dataset = get_dataset_name()  # æ•°æ®é›†åç§°
    preproces(dataset)  # é¢„å¤„ç†å‡½æ•°

    # æ”¶é›†ç»“æŸæ—¶é—´
    end_time = time.time()
    print("2.pyçš„è¿è¡Œæ—¶é—´: {:.2f} ç§’".format(end_time - start_time))

if __name__ == '__main__':
    main()

    
