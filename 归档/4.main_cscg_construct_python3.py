# coding=utf-8

"""
æˆ‘ä¿®æ”¹äº†create_graph_fileså‡½æ•°ï¼Œåœ¨ç”Ÿæˆçš„æ—¶å€™è®°å½•é”™è¯¯apkä¿¡æ¯å¹¶ç”Ÿæˆä¸€ä¸ªtxtæ–‡ä»¶ï¼Œå‡½æ•°ç»“æŸåè¯¢é—®æˆ‘æ˜¯å¦åˆ é™¤é”™è¯¯apk
/home/czc/code/Android_Malware_Detection/code/android_malware_detection/data/error_apks.txt

è¿™é‡Œå–æ¶ˆäº†è¿›ç¨‹æ± ï¼Œå› ä¸ºåœ¨è·‘çš„æ—¶å€™éœ€è¦ä¸€ä¸ªä¸€ä¸ªè·‘ï¼Œç”¨äºè·å–é”™è¯¯apkçš„ä¿¡æ¯ï¼Œä¿å­˜æ–‡ä»¶åœ¨ï¼š
/home/czc/code/Android_Malware_Detection/code/android_malware_detection/data/error_apks.txt

å¦‚æœç¬¬ä¸€éè·‘è¿‡äº†ï¼Œå¹¶åˆ é™¤äº†æ‰€æœ‰é”™è¯¯apkï¼Œå¯ä»¥ç”¨è¿›ç¨‹æ± æ¥è·‘create_graph_fileså‡½æ•°
ï¼ˆç”¨è¿›ç¨‹æ± æ¥è·‘æˆ‘çš„åé¢è¦æ±‚è¾“å…¥æ˜¯å¦åˆ é™¤é”™è¯¯apkçš„inputæ–¹æ³•ä¼šä¸ä¼šå‡ºé—®é¢˜????æœ€å¥½å°±åˆ†å¼€è·‘å§ï¼‰

202410272330
æ•°æ®é›†ï¼šczc_dataset_VS_Drebin_AndroZoo 6000ä¸ªapkï¼Œè¿è¡Œæ—¶é—´:  3000ç§’
æ€»è¿è¡Œæ—¶é—´: 3158.55 ç§’

æ•°æ®é›†ï¼šczc_dataset_4 6000ä¸ªapkï¼Œè¿è¡Œæ—¶é—´: 664.65 ç§’
"""

import os
from multiprocessing import Pool
from static import get_lsi_config, get_cscg_config, get_graph_config
from static import total_process_multi_core, total_process_single_core, ts_max, min_k_tmp_file
from static import get_dataset_name
from lsi.lsi import lsi_train, lsi_test_cscg
from CSCG.calculate_min_k import calculate_min_k
from CSCG.java_graph import get_cscg_dataset
from GAT.create_graph_dataset import create_graph_files
import time

# æ”¶é›†å¼€å§‹æ—¶é—´
start_time = time.time()

program_root = os.getcwd()
# æ·»åŠ apktoolçš„ç¯å¢ƒå˜é‡
os.environ["PATH"] = program_root + '/tools/apktool/' + ":" + os.environ["PATH"]
# æ·»åŠ jadxçš„ç¯å¢ƒå˜é‡
os.environ["PATH"] = program_root + '/tools/jadx/build/jadx/bin/' + ":" + os.environ["PATH"]


# åŸºäºjavaæ–‡ä»¶çš„importå…³ç³»è¿›è¡Œå›¾æ„å»ºï¼Œç›¸å½“äºpublic classçš„è°ƒç”¨å…³ç³»ï¼Œå¹¶ä¿ç•™ä¸€å®šçš„3rdåº“ï¼Œä½¿å¾—è¿‡æ»¤åèŠ‚ç‚¹æ•°é‡å°äº100çš„ï¼Œå°½é‡è¡¥å……åˆ°æ¥è¿‘100
def class_set_call_graph(dataset):
    # dataset_name æ•°æ®é›†çš„åç§°,
    # java_path åŸå§‹javaä»£ç å‹ç¼©åŒ…çš„å­˜æ”¾è·¯å¾„,
    # java_graph_path ä¿å­˜class-set call graphè°ƒç”¨å…³ç³»çš„è·¯å¾„,
    # _3rd_path ä¸‰æ–¹åº“æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„,
    # token_file_root ä¿å­˜æ¯ä¸ªclass-setçš„æ­¤æ³•åˆ†æå¾—åˆ°çš„tokens,
    # min_k è¯¥æ•°æ®é›†ä¸‹çš„min_kå€¼

    # 16.è·å–CSCGçš„é…ç½®ä¿¡æ¯
    print("ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£16.è·å–CSCGçš„é…ç½®ä¿¡æ¯")
    time.sleep(3)
    java_path, java_graph_path, _3rd_path, token_file_root= get_cscg_config(dataset)
    train_file, test_file, TFIDF_dict_path, dict_corpus, TFIDF_model_path, TFIDF_corpus_path, LSI_model_path, LSI_corpus_path, LSI_corpus_path_test, token_root, apktool_root_path, no_below, no_above = get_lsi_config(dataset, type='cscg')

    # 17.è®¡ç®—min_k
    print("ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£17.è®¡ç®—min_k")
    time.sleep(3)
    min_k = calculate_min_k(dataset, java_path, train_file, ts_max, min_k_tmp_file)

    # 18.è®¡ç®—CSCGè°ƒç”¨å›¾ï¼Œå¹¶å¯¹èŠ‚ç‚¹è¿›è¡Œåˆ†è¯
    print("ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£18.è®¡ç®—CSCGè°ƒç”¨å›¾ï¼Œå¹¶å¯¹èŠ‚ç‚¹è¿›è¡Œåˆ†è¯")
    time.sleep(3)
    get_cscg_dataset(dataset, java_path, java_graph_path, _3rd_path, token_file_root, min_k=min_k, total_process=total_process_single_core)

    # æå–class-setçš„LSIå‘é‡ï¼Œæ¯ä¸ªAPKä¿å­˜æˆä¸€ä¸ªæ–‡ä»¶
    # pool = Pool(processes=2)
    # 19.ç”Ÿæˆè®­ç»ƒé›†çš„èŠ‚ç‚¹ç‰¹å¾å‘é‡
    print("ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£19.ç”Ÿæˆè®­ç»ƒé›†çš„èŠ‚ç‚¹ç‰¹å¾å‘é‡ trainâ—trainâ—trainâ—")
    time.sleep(3)
    lsi_test_cscg(dataset, train_file, TFIDF_dict_path, TFIDF_model_path, LSI_model_path, LSI_corpus_path, token_root, type='cscg')
    # pool.apply_async(lsi_test_cscg, (dataset, train_file, TFIDF_dict_path, TFIDF_model_path, LSI_model_path, LSI_corpus_path, token_root, 'cscg'))

    # 20.ç”Ÿæˆæµ‹è¯•é›†çš„èŠ‚ç‚¹ç‰¹å¾å‘é‡
    print("ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£20.ç”Ÿæˆæµ‹è¯•é›†çš„èŠ‚ç‚¹ç‰¹å¾å‘é‡ testâ—testâ—testâ—")
    time.sleep(3)
    lsi_test_cscg(dataset, test_file, TFIDF_dict_path, TFIDF_model_path, LSI_model_path, LSI_corpus_path_test, token_root, type='cscg')
    # pool.apply_async(lsi_test_cscg, (dataset, test_file, TFIDF_dict_path, TFIDF_model_path, LSI_model_path, LSI_corpus_path_test, token_root, 'cscg'))
    # pool.close()
    # pool.join()

    # é˜²æ­¢å¤šæ¬¡è°ƒå‚æ—¶ï¼Œè¯»å–ç¢æ–‡ä»¶å¤ªè€—æ—¶é—´ï¼Œå› æ­¤å…ˆå°†CSCGä¿å­˜æˆå¤§æ–‡ä»¶
    print("ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£é˜²æ­¢å¤šæ¬¡è°ƒå‚æ—¶ï¼Œè¯»å–ç¢æ–‡ä»¶å¤ªè€—æ—¶é—´ï¼Œå› æ­¤å…ˆå°†CSCGä¿å­˜æˆå¤§æ–‡ä»¶")
    time.sleep(3)
    # pool = Pool(processes=2)

    # 21.è¯»å–PSCNçš„è¾“å…¥graphæºæ–‡ä»¶
    print("ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£21.è¯»å–PSCNçš„è¾“å…¥graphæºæ–‡ä»¶")
    time.sleep(3)
    train_file, test_file, LSI_corpus_path, LSI_corpus_path_test, graph_file_root, model_root, permission_feature_path, lsi_fearue_file, lsi_fearue_file_test = get_graph_config(dataset)

    # é€‰æ‹©æ˜¯å¦ä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œ22å’Œ23æ­¥
    use_pool = False

    if not use_pool:
        print("â€¼ï¸â—â€¼ï¸â—â€¼ï¸â—â€¼ï¸â—ä¸ä½¿ç”¨è¿›ç¨‹æ± ")
        # 22.ç”Ÿæˆè®­ç»ƒé›†çš„graphæ–‡ä»¶
        print("ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£22.ç”Ÿæˆè®­ç»ƒé›†çš„graphæ–‡ä»¶")
        time.sleep(5)
        create_graph_files(train_file, graph_file_root, LSI_corpus_path, model_root, lsi_fearue_file, permission_feature_path=permission_feature_path, type='cscg', apktool_root_path=apktool_root_path, add_root=False)
        # pool.apply_async(create_graph_files, (train_file, graph_file_root, LSI_corpus_path, model_root, lsi_fearue_file, permission_feature_path, 'cscg', apktool_root_path, False))

        # 23.ç”Ÿæˆæµ‹è¯•é›†çš„graphæ–‡ä»¶
        print("ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£23.ç”Ÿæˆæµ‹è¯•é›†çš„graphæ–‡ä»¶")
        time.sleep(5)
        create_graph_files(test_file, graph_file_root, LSI_corpus_path_test, model_root, lsi_fearue_file_test, permission_feature_path=permission_feature_path, type='cscg',  apktool_root_path=apktool_root_path)
        # pool.apply_async(create_graph_files, (test_file, graph_file_root, LSI_corpus_path_test, model_root, lsi_fearue_file_test, permission_feature_path, 'cscg', apktool_root_path, False))
        # pool.close()
        # pool.join()  
        # # czc: å¦‚æœä½¿ç”¨è¿›ç¨‹æ± ï¼šè¿™é‡Œç”Ÿæˆè®­ç»ƒé›†å’Œç”Ÿæˆæµ‹è¯•é›†åŒæ—¶å¼€å§‹äº†ï¼Œ
        # # åˆ°åé¢ç”±äºæµ‹è¯•é›†æ•°é‡å°‘æå‰ç”Ÿæˆå®Œæ¯•ç»“æŸï¼Œç„¶åè®­ç»ƒé›†çš„ç”Ÿæˆä¹ŸåŒæ—¶ç»“æŸï¼Œä½†æ­¤æ—¶è®­ç»ƒé›†å¹¶æ²¡æœ‰ç”Ÿæˆå®Œæ¯•
        # # è®­ç»ƒé›†æå‰ç»“æŸæ˜¯å› ä¸ºæŸä¸ªxmlæœ‰é—®é¢˜å¯¼è‡´é”™è¯¯æ‰€ä»¥è¿›ç¨‹åœæ­¢ï¼Œä½†æ˜¯æµ‹è¯•é›†è¿˜åœ¨ç”Ÿæˆï¼Œæ‰€ä»¥é€ æˆè¿™ä¸ªç°è±¡

    else:
        print("â€¼ï¸â—â€¼ï¸â—â€¼ï¸â—â€¼ï¸â—ä½¿ç”¨è¿›ç¨‹æ± ")
        # ä½¿ç”¨è¿›ç¨‹æ± è¿›è¡Œ22å’Œ23æ­¥
        time.sleep(5)
        pool = Pool(processes=2)
        pool.apply_async(create_graph_files, (train_file, graph_file_root, LSI_corpus_path, model_root, lsi_fearue_file, permission_feature_path, 'cscg', apktool_root_path, False))
        create_graph_files(test_file, graph_file_root, LSI_corpus_path_test, model_root, lsi_fearue_file_test, permission_feature_path=permission_feature_path, type='cscg',  apktool_root_path=apktool_root_path)
        pool.close()
        pool.join()




def main():
    dataset = get_dataset_name()
    class_set_call_graph(dataset)

    # æ”¶é›†ç»“æŸæ—¶é—´
    end_time = time.time()
    print("4.pyçš„è¿è¡Œæ—¶é—´: {:.2f} ç§’".format(end_time - start_time))


if __name__ == '__main__':
    main()



