# coding=utf-8

"""
202410272331
数据集：czc_dataset_VS_Drebin_AndroZoo 6000个apk，运行时间:  秒

202411041600，数据集：czc_dataset_7 6000个apk，运行时间: 3136.89 秒
......
Train Epoch: 50 [2710/2727 (99%)]       Loss: 0.000000 (avg: 0.001484)  sec/iter: 0.1041
Train Epoch: 50 [2727/2727 (100%)]      Loss: 0.000005 (avg: 0.001475)  sec/iter: 0.1041
Test set (epoch 50): Average loss: 0.0001, Accuracy: 2727/2727 (100.00%)        sec/iter: 0.0918
0->0: 583, 0->1: 0, 1->0: 0, 1->1: 2144

Test set (epoch 50): Average loss: 0.1278, Accuracy: 297/304 (97.70%)   sec/iter: 0.0901
0->0: 64, 0->1: 2, 1->0: 5, 1->1: 233

Test set (epoch 50): Average loss: 0.0438, Accuracy: 759/766 (99.09%)   sec/iter: 0.1177
0->0: 147, 0->1: 3, 1->0: 4, 1->1: 612

[[99.08616187989556, 147, 3, 4, 612]]
Test avg acc (+- std): 99.08616187989556 (0.0)
总运行时间: 3136.89 秒

"""

import os
from static import get_graph_config
from static import get_dataset_name
from GAT.graph_net import graph_model
import time

# 收集开始时间
start_time = time.time()

program_root = os.getcwd()
# 添加apktool的环境变量
os.environ["PATH"] = program_root + '/tools/apktool/' + ":" + os.environ["PATH"]
# 添加jadx的环境变量
os.environ["PATH"] = program_root + '/tools/jadx/build/jadx/bin/' + ":" + os.environ["PATH"]


# 基于java文的import关系进行图构建，相当于public class的调用关系，并保留一定的3rd库，使得过滤后节点数量小于100的，尽量补充到接近100
def class_set_call_graph_test(dataset):
    # 12.读取PSCN的输入graph源文件
    # czc-cursor：PSCH是public class的调用关系，并保留一定的3rd库，使得过滤后节点数量小于100的，尽量补充到接近100
    train_file, test_file, LSI_corpus_path, LSI_corpus_path_test, graph_file_root, \
    model_root, permission_feature_path, lsi_fearue_file, lsi_fearue_file_test = get_graph_config(dataset)

    # 15.graph_net训练测试
    graph_model(model_root, dataset)  # 训练和测试, 训练和测试的模型文件都保存在model_root目录下

def main():
    dataset = get_dataset_name()
    class_set_call_graph_test(dataset)

    # 收集结束时间
    end_time = time.time()
    print("5.py的运行时间: {:.2f} 秒".format(end_time - start_time))

if __name__ == '__main__':

    main()
