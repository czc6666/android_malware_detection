# coding=utf-8
import os
# result_file = open("/home/audr/syc_disk/syc/AndroZoo_white/Androzoo_white_4_filelist.txt",'w+')
# third_filt_result = '/home/audr/syc_disk/syc/AndroZoo_white/Androzoo_white_4_3rd/'
# apktool_result = '/home/audr/syc_disk/syc/AndroZoo_white/Androzoo_white_4_manifest/'
# java_path = '/home/audr/syc_disk/syc/AndroZoo_white/Androzoo_white_4_java/'
import zipfile  # 导入zipfile模块

def read_old_filelist(filelist_file):  # 读取旧的文件列表
    fi = open(filelist_file, 'r')  # 打开文件列表文件
    lines_old = []  # 旧的文件列表
    filelist = []  # 新的文件列表
    while True:  
        lines = fi.readlines(10000)  # 读取10000行
        if not lines:  # 如果读取的行数为0，则跳出循环
            break
        for line in lines:
            lines_old.append(line.strip())  # 将行中的空白字符去掉并添加到旧的文件列表中
            filelist.append(line.split(' ')[0])  # 将行中的第一个元素添加到新的文件列表中

    fi.close()  # 关闭文件
    return lines_old, filelist  # 返回旧的文件列表和新的文件列表

def create_filelist(filelist_file, filelist_filter, _3rd_filter_result, manifest_result, java_path):  # 创建文件列表
    # 输入：文件列表文件，过滤后文件列表，第三方过滤结果，manifest结果，java路径
    # 输出：过滤后的文件列表
    # 读取旧的文件列表和新的文件列表
    lines_old, filelist = read_old_filelist(filelist_file)  # 读取旧的文件列表和新的文件列表
    # print(filelist_file, filelist_filter, _3rd_filter_result, manifest_result, java_path)
    # raise Exception
    fo = open(filelist_filter, 'w+')  # 打开过滤后的文件列表文件
    for i in range(len(filelist)):
        filename = filelist[i]
        line_old = lines_old[i]
        _3rd_file = filename[:-4] + '.3rd'
        manifest = manifest_result + filename + '/AndroidManifest.xml'
        source_zip = java_path + filename + '.zip'
        # 确保有manifest文件：
        if not os.path.exists(manifest):
            print(filename + ' not contain manifest!')
            continue
        # 确保有java源码的zip文件
        if not os.path.exists(source_zip):
            print(filename + ' not contain source.zip')
            continue
        # 确保有LiteRadar生成的3rd文件
        if not os.path.exists(source_zip):
            print(filename + ' not contain source.zip')
            continue
        # 确保zip文件里有source文件夹，证明有解析出来的java文件
        z = zipfile.ZipFile(source_zip, 'r')
        found_source = False
        for file_in_zip in z.namelist():
            # if file_in_zip.endswith('/') and file_in_zip == 'src/sources/':
            if file_in_zip.endswith('.java') and file_in_zip.startswith('src/sources/'):
                found_source = True
                break
        if not found_source:
            print(filename + ' not contain src/sources/')
            continue
        print("found file: " + filename)

        fo.write(line_old + '\n')
    fo.close()


# if __name__ == '__main__':
#     create_filelist('/data2/android_malware_detection/dataset/中心黑白/My_white_filelist.txt', \
#                     '/data2/android_malware_detection/3rd/中心黑白/white/',
#                     '/data2/android_malware_detection/apk_tool/中心黑白/white/manifest/',
#                     '/data2/android_malware_detection/java/中心黑白/white/')