# coding=utf-8
import os
import sys

from static import get_apk_path
from static import total_process_single_core
from static import get_dataset_name

from LiteRadar.filter_dex import filter_dex

from czc.fun_timer import fun_timer

program_root = os.getcwd()
# 添加apktool的环境变量
os.environ["PATH"] = program_root + '/tools/apktool/' + ":" + os.environ["PATH"]
# 添加jadx的环境变量
os.environ["PATH"] = program_root + '/tools/jadx/build/jadx/bin/' + ":" + os.environ["PATH"]


# 对原始APK文件进行预处理，包括反编译、三方库过滤等
def literadar(dataset):
    # 1. 获取数据集的配置
    apk_path, manifest_path, dex_path, java_path, _3rd_path, permission_path, token_path, filelist_train, filelist_test, filelist_train_filter, filelist_test_filter = get_apk_path(dataset)

    # 2.使用LiteRadar获取每个apk文件的三方库
    filter_dex(apk_path, _3rd_path, total_process_single_core)

    # 3. 统计生成了多少个三方库文件
    print("生成了{}个三方库文件".format(len(os.listdir(_3rd_path))))

@fun_timer
def main():
    dataset = get_dataset_name()

    # 对原始APK文件进行预处理，包括反编译、三方库过滤等
    literadar(dataset)

if __name__ == '__main__':
    main()